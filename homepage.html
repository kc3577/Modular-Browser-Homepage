<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Startpage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link id="faviconLink" rel="icon" type="image/x-icon" href="">
    <style>
        /* Basic page styles */
        html, body { /* Ensure HTML and Body take full height */
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, background-image 0.3s ease; /* Smooth transition for background */
            background-size: cover; /* Image covers the entire area */
            background-position: center; /* Center the image */
            background-repeat: no-repeat; /* Do not repeat image */
            background-attachment: fixed; /* Fix image on scroll */
        }

        /* Style for the button container to center the buttons */
        .tiles-grid {
            display: grid;
            /* Column count and width are fixed, based on max-cols and base-tile-height */
            grid-template-columns: repeat(var(--max-cols, 6), var(--base-tile-height, 150px));
            /* Row height is fixed, based on base-tile-height */
            grid-auto-rows: var(--base-tile-height, 150px);
            gap: 1rem; /* Space between buttons */
            /* Fixed grid width, calculated from column count, tile height, gaps AND padding AND border */
            width: calc(var(--max-cols, 6) * var(--base-tile-height, 150px) + (var(--max-cols, 6) - 1) * 1rem + 2rem + 4px);
            margin: 0 auto; /* Center the grid */
            padding: 1rem; /* Inner spacing */
            /* Maximum height of the grid based on visible rows and tile height */
            max-height: calc(var(--max-rows, 3) * var(--base-tile-height, 150px) + (var(--max-rows, 3) - 1) * 1rem);
            overflow-y: auto; /* Enable vertical scrolling if content exceeds max-height */
            overflow-x: hidden; /* Explicitly prevent horizontal scrollbar */
            position: relative; /* Important for absolute positioning of the indicator */
            border-radius: 0.5rem; /* Rounded corners for the grid */
            border: 2px solid transparent; /* Transparent border by default, but solid */
            box-shadow: 0 0 0 rgba(0, 0, 0, 0); /* No shadow by default */
            transition: border-color 0.2s ease, box-shadow 0.2s ease; /* Transition for the border */
        }

        /* Style for individual buttons (tiles) */
        .tile {
            display: flex; /* Use flex to center content when only title is visible */
            justify-content: center;
            align-items: center;
            border-radius: 0.5rem; /* Rounded corners */
            color: white;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease; /* Hover effects */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Slight shadow */
            /* aspect-ratio: 1 / 1; REMOVED: Aspect ratio is now controlled by grid-column/grid-row */
            position: relative; /* For overflow hidden, if image goes outside */
            overflow: hidden; /* Ensures image respects border-radius */
        }

        /* Hover effect for buttons */
        .tile:hover {
            transform: scale(1.05); /* Slightly enlarge on hover */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2); /* Stronger shadow on hover */
        }

        /* Style for the image/icon within the tile */
        .tile img {
            width: 100%; /* Image fills the entire width of the container */
            height: 100%; /* Image fills the entire height of the container */
            object-fit: contain; /* Adjust image to fit within the area without being cropped */
            border-radius: 0.5rem; /* Rounded corners for images - MATCHES PARENT */
            position: absolute; /* Absolute position to fill the button */
            top: 0;
            left: 0;
            z-index: 1; /* Image below the title */
        }

        /* Style for the title within the tile */
        .tile h3 {
            font-size: 1.125rem; /* Font size of the title */
            font-weight: 600; /* Semi-bold */
            white-space: nowrap; /* Prevent line breaks */
            overflow: hidden; /* Hide overflowing text */
            text-overflow: ellipsis; /* Three dots on overflow */
            max-width: 90%; /* Maximum width of the title, with some margin */
            padding: 0.5rem; /* Padding for the title */
            position: absolute; /* Absolute position to lie above the image */
            top: 50%; /* Vertically center */
            left: 50%; /* Horizontally center */
            transform: translate(-50%, -50%); /* Exact centering */
            z-index: 2; /* Title above the image */
            text-shadow: 0 0 5px rgba(0,0,0,0.7); /* Slight shadow for better readability */
        }

        /* CSS classes for various tile sizes */
        /* Sizes are now directly controlled by spanning grid cells */
        .tile[data-size="1x1"] {
            grid-column: span 1;
            grid-row: span 1;
        }
        .tile[data-size="2x1"] { /* Wide tile */
            grid-column: span 2;
            grid-row: span 1;
        }
        .tile[data-size="1x2"] { /* Tall tile */
            grid-column: span 1;
            grid-row: span 2;
        }
        .tile[data-size="2x2"] { /* Large tile */
            grid-column: span 2;
            grid-row: span 2;
        }
        .tile[data-size="3x1"] { /* Very Wide tile */
            grid-column: span 3;
            grid-row: span 1;
        }
        .tile[data-size="1x3"] { /* Very Tall tile */
            grid-column: span 1;
            grid-row: span 3;
        }

        /* Style for the modal (settings window) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 100; /* Above everything else */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Scrollbar if content is too large */
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent background */
            backdrop-filter: blur(5px); /* Blur effect */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #2d3748; /* Dark background for the modal */
            padding: 2rem;
            border-radius: 0.75rem; /* Rounded corners */
            width: 90%;
            max-width: 600px; /* Maximum width */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); /* Stronger shadow */
            color: white;
            display: flex;
            flex-direction: column;
        }

        .modal-content input[type="text"],
        .modal-content input[type="url"],
        .modal-content input[type="color"],
        .modal-content select,
        .modal-content input[type="file"],
        .modal-content input[type="number"] { /* Also for file input and number input */
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #4a5568; /* Darker border */
            border-radius: 0.375rem;
            background-color: #4a5568; /* Dark background for input fields */
            color: white;
        }

        .modal-content input[type="file"] {
            padding: 0.5rem; /* Slightly less padding for file input */
        }

        .modal-content button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        /* Style for the search bar */
        .search-bar {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            width: 100%;
            padding: 0 1rem;
        }

        .search-bar input {
            width: 100%;
            max-width: 600px;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px; /* Pill shape */
            border: 1px solid #4a5568;
            background-color: rgba(45, 55, 72, 0.7); /* Semi-transparent */
            color: white;
            outline: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-bar input::placeholder {
            color: #a0aec0;
        }

        /* Style for the quick search provider dropdown */
        #quickSearchProviderSelect {
            background-color: rgba(45, 55, 72, 0.7); /* Semi-transparent */
            color: white;
            padding: 0.75rem 1.25rem; /* Adjusted to match input padding */
            border-radius: 9999px; /* Pill shape */
            border: 1px solid #4a5568;
            focus:ring-2 focus:ring-blue-500;
        }

        /* New styles for settings categories and submenus */
        .settings-category-button {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #4A5568; /* Darker gray */
            color: white;
            font-size: 1.125rem;
            font-weight: 600;
            border-radius: 0.5rem;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-category-button:hover {
            background-color: #636B7A; /* Even darker gray on hover */
        }

        .settings-submenu {
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .back-to-main-menu-button {
            background-color: #6B7280;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            margin-bottom: 1.5rem;
            align-self: flex-start;
        }

        .back-to-main-menu-button:hover {
            background-color: #8D94A0;
        }

        /* Container for the two fixed buttons */
        #controlButtonsContainer {
            position: fixed;
            z-index: 50;
            display: flex;
            align-items: center; /* Vertically center */
            gap: 0.5rem; /* Space between buttons */
            transition: all 0.3s ease; /* Smooth transition for position changes */
        }

        /* Positioning classes for the container */
        .container-top-left { top: 1rem; left: 1rem; }
        .container-top-right { top: 1rem; right: 1rem; }
        .container-bottom-left { bottom: 1rem; left: 1rem; }
        .container-bottom-right { bottom: 1rem; right: 1rem; }


        /* Styles for the settings button */
        #settingsButton {
            z-index: 50; /* Keep z-index for stacking within the fixed container */
            background-color: #2563EB; /* Default blue */
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem; /* Default padding for text */
            border-radius: 9999px; /* Pill shape */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap; /* Prevent text wrapping */
        }

        #settingsButton:hover {
            background-color: #1D4ED8; /* Darker blue on hover */
        }

        /* Style for icon-only button */
        #settingsButton.icon-only {
            width: 50px; /* Adjusted size for icon */
            height: 50px;
            padding: 0; /* Remove padding for icon only */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem; /* Icon size */
        }

        /* Style for the lock button */
        #toggleLockButtonsButton {
            z-index: 50; /* Keep z-index for stacking within the fixed container */
            width: 44px; /* Smaller size */
            height: 44px;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #4a5568; /* Muted gray for locked */
            color: white;
            border-radius: 9999px; /* Circular */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Lighter shadow */
            transition: background-color 0.3s ease, transform 0.2s ease;
            font-size: 1.2rem; /* Icon size */
        }
        #toggleLockButtonsButton:hover {
            transform: scale(1.1);
            background-color: #636B7A; /* Slightly darker gray on hover */
        }
        #toggleLockButtonsButton.unlocked {
            background-color: #3B82F6; /* A more prominent blue for unlocked */
        }
        #toggleLockButtonsButton.unlocked:hover {
            background-color: #2563EB; /* Darker blue on hover when unlocked */
        }

        /* Drag & Drop Visuals */
        .tile.opacity-0 { /* Original dragged tile */
            opacity: 0;
        }
        /* New style for the line indicator */
        .line-indicator {
            background-color: #3B82F6; /* Blue line */
            position: absolute; /* Absolute positioning */
            width: 2px; /* Thin vertical line */
            z-index: 10; /* Above the buttons */
            border-radius: 1px; /* Rounded ends */
            display: none; /* Hidden by default */
            transition: left 0.1s ease, top 0.1s ease; /* Smooth transition for position */
        }

        /* New style for the tiles-grid when dragging is active */
        .tiles-grid.drag-active {
            border-color: #3B82F6; /* Blue dashed border */
            border-style: solid; /* Changed from dashed to solid */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); /* Glowing shadow */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

    <div class="flex-grow flex flex-col items-center justify-center p-4" id="mainContentWrapper">
        <h1 id="pageTitle" class="text-4xl font-bold mb-8 text-center"></h1>

        <div id="searchBarContainer" class="search-bar flex items-center gap-2 mx-auto max-w-2xl">
            <div class="relative flex-grow">
                <input type="search" id="googleSearchInput" class="focus:ring-2 focus:ring-blue-500 w-full pl-4 pr-10 py-2 rounded-full border border-gray-600 bg-gray-700 text-white outline-none shadow-md">
                <i id="searchIcon" class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 cursor-pointer"></i>
            </div>
            <select id="quickSearchProviderSelect" class="bg-gray-700 text-white p-2 rounded-full border border-gray-600 focus:ring-2 focus:ring-blue-500">
                <option value="google">Google</option>
                <option value="bing">Bing</option>
                <option value="duckduckgo">DuckDuckGo</option>
                <option value="ecosia">Ecosia</option>
                <option value="wikipedia">Wikipedia</option>
            </select>
        </div>

        <div id="tilesContainer" class="tiles-grid">
            </div>

        <div id="controlButtonsContainer">
            <button id="toggleLockButtonsButton">
                <i class="fas fa-lock"></i>
            </button>
            <button id="settingsButton">
                Settings
            </button>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-center" id="modalTitle"></h2>

            <div id="mainSettingsMenu" class="settings-submenu">
                <button id="openBackgroundSettings" class="settings-category-button">
                    <span data-i18n="backgroundSettings"></span>
                    <span class="ml-2">></span>
                </button>
                <button id="openPageTitleSettings" class="settings-category-button">
                    <span data-i18n="pageTitleSettings"></span>
                    <span class="ml-2">></span>
                </button>
                <button id="openSearchBarSettings" class="settings-category-button">
                    <span data-i18n="searchBarSettings"></span>
                    <span class="ml-2">></span>
                </button>
                <button id="openGridSettings" class="settings-category-button">
                    <span data-i18n="gridSettings"></span>
                    <span class="ml-2">></span>
                </button>
                <button id="openButtonManagement" class="settings-category-button">
                    <span data-i18n="manageButtons"></span>
                    <span class="ml-2">></span>
                </button>
                <button id="openSettingsButtonSettings" class="settings-category-button">
                    <span data-i18n="settingsButtonSettings"></span>
                    <span class="ml-2">></span>
                </button>
                <button id="openLanguageSettings" class="settings-category-button">
                    <span data-i18n="languageSettings"></span>
                    <span class="ml-2">></span>
                </button>
                <button id="openBackupRestoreSettings" class="settings-category-button">
                    <span data-i18n="backupRestoreData"></span>
                    <span class="ml-2">></span>
                </button>
            </div>

            <div id="backgroundSettingsSubmenu" class="hidden settings-submenu">
                <button class="back-to-main-menu-button" data-i18n="back"></button>
                <h3 class="text-xl font-semibold mb-3" data-i18n="backgroundSettings"></h3>
                <div class="mb-4">
                    <label for="backgroundTypeSelect" class="block text-sm font-medium mb-2" data-i18n="backgroundType"></label>
                    <select id="backgroundTypeSelect">
                        <option value="color" data-i18n="solidColorBackground"></option>
                        <option value="image" data-i18n="imageBackground"></option>
                        <option value="gradient" data-i18n="gradientBackground"></option>
                    </select>
                </div>

                <div id="backgroundColorOptions" class="mb-4">
                    <label for="bgColorPicker" class="block text-sm font-medium mb-2" data-i18n="backgroundColor"></label>
                    <input type="color" id="bgColorPicker" class="h-10 w-full p-0 border-none cursor-pointer">
                </div>

                <div id="backgroundImageOptions" class="hidden">
                    <div class="mb-4">
                        <label for="backgroundImageFile" class="block text-sm font-medium mb-2" data-i18n="selectImageFromFile"></label>
                        <input type="file" id="backgroundImageFile" accept="image/*" class="mb-2">
                    </div>
                    <div class="mb-4">
                        <label for="backgroundImageUrl" class="block text-sm font-medium mb-2" data-i18n="imageUrl"></label>
                        <input type="url" id="backgroundImageUrl" placeholder="https://example.com/background.jpg">
                    </div>
                    <img id="currentBackgroundPreview" src="" alt="Background Image Preview" class="w-full h-32 object-cover rounded-md border border-gray-600 mb-4">
                </div>

                <div id="backgroundGradientOptions" class="hidden">
                    <div class="mb-4">
                        <label for="gradientColor1" class="block text-sm font-medium mb-2" data-i18n="gradientColor1"></label>
                        <input type="color" id="gradientColor1" class="h-10 w-full p-0 border-none cursor-pointer">
                    </div>
                    <div class="mb-4">
                        <label for="gradientColor2" class="block text-sm font-medium mb-2" data-i18n="gradientColor2"></label>
                        <input type="color" id="gradientColor2" class="h-10 w-full p-0 border-none cursor-pointer">
                    </div>
                    <div class="mb-4">
                        <label for="gradientDirection" class="block text-sm font-medium mb-2" data-i18n="gradientDirection"></label>
                        <select id="gradientDirection">
                            <option value="to right" data-i18n="toRight"></option>
                            <option value="to bottom" data-i18n="toBottom"></option>
                            <option value="to bottom right" data-i18n="toBottomRight"></option>
                            <option value="to bottom left" data-i18n="toBottomLeft"></option>
                            <option value="to top" data-i18n="toTop"></option>
                            <option value="to top right" data-i18n="toTopRight"></option>
                            <option value="to top left" data-i18n="toTopLeft"></option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="pageTitleSettingsSubmenu" class="hidden settings-submenu">
                <button class="back-to-main-menu-button" data-i18n="back"></button>
                <h3 class="text-xl font-semibold mb-3" data-i18n="pageTitleSettings"></h3>
                <div class="mb-4">
                    <label for="pageTitleInput" class="block text-sm font-medium mb-2" data-i18n="pageTitle"></label>
                    <input type="text" id="pageTitleInput" data-i18n-placeholder="yourPageTitle">
                </div>
                <div class="mb-4">
                    <label for="pageTitleFontSelect" class="block text-sm font-medium mb-2" data-i18n="titleFont"></label>
                    <select id="pageTitleFontSelect"></select>
                </div>
                <div class="flex items-center mb-4">
                    <input type="checkbox" id="hidePageTitleCheckbox" class="mr-2 h-4 w-4 text-blue-600 rounded">
                    <label for="hidePageTitleCheckbox" class="text-sm font-medium" data-i18n="hidePageTitle"></label>
                </div>
                <div class="mb-4">
                    <label for="tabTitleInput" class="block text-sm font-medium mb-2" data-i18n="tabTitle"></label>
                    <input type="text" id="tabTitleInput" data-i18n-placeholder="browserTabTitle">
                </div>
                <div class="mb-4">
                    <label for="faviconFileInput" class="block text-sm font-medium mb-2" data-i18n="selectFavicon"></label>
                    <input type="file" id="faviconFileInput" accept=".ico,image/png,image/gif" class="mb-2">
                    <img id="faviconPreview" src="" alt="Favicon Preview" class="w-10 h-10 object-contain rounded-md border border-gray-600">
                </div>
            </div>

            <div id="searchBarSettingsSubmenu" class="hidden settings-submenu">
                <button class="back-to-main-menu-button" data-i18n="back"></button>
                <h3 class="text-xl font-semibold mb-3" data-i18n="searchBarSettings"></h3>
                <div class="mb-4">
                    <label for="searchProviderSelect" class="block text-sm font-medium mb-2" data-i18n="defaultSearchProvider"></label>
                    <select id="searchProviderSelect">
                        <option value="google">Google</option>
                        <option value="bing">Bing</option>
                        <option value="duckduckgo">DuckDuckGo</option>
                        <option value="ecosia">Ecosia</option>
                        <option value="wikipedia">Wikipedia</option>
                    </select>
                </div>
            </div>

            <div id="gridSettingsSubmenu" class="hidden settings-submenu">
                <button class="back-to-main-menu-button" data-i18n="back"></button>
                <h3 class="text-xl font-semibold mb-3" data-i18n="gridSettings"></h3>
                <div class="mb-4">
                    <label for="maxColumnsInput" class="block text-sm font-medium mb-2" data-i18n="maxColumns"></label>
                    <input type="number" id="maxColumnsInput" min="1" value="6">
                </div>
                <div class="mb-4">
                    <label for="baseTileHeightInput" class="block text-sm font-medium mb-2" data-i18n="baseTileHeight"></label>
                    <input type="number" id="baseTileHeightInput" min="50" value="150">
                </div>
            </div>

            <div id="buttonManagementSubmenu" class="hidden settings-submenu">
                <button class="back-to-main-menu-button" data-i18n="back"></button>
                <h3 class="text-xl font-semibold mb-3" data-i18n="manageButtons"></h3>
                <div class="flex justify-between gap-4 mb-4">
                    <button id="addButton" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex-grow" data-i18n="addButton"></button>
                    <button id="removeButton" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md flex-grow" data-i18n="removeSelectedButton"></button>
                </div>
                <div class="mb-4">
                    <label for="buttonSelect" class="block text-sm font-medium mb-2" data-i18n="selectButtonToEdit"></label>
                    <select id="buttonSelect">
                        </select>
                </div>
                <div id="buttonEditForm" class="hidden">
                    <div class="mb-4">
                        <label for="buttonTitle" class="block text-sm font-medium mb-2">
                            <span data-i18n="title"></span>: <span class="text-gray-400 text-sm" data-i18n="titleHiddenIfImage"></span>
                        </label>
                        <input type="text" id="buttonTitle" data-i18n-placeholder="buttonTitle">
                    </div>

                    <div id="buttonUrlOptions" class="mb-4">
                        <label for="buttonLink" class="block text-sm font-medium mb-2" data-i18n="linkUrl"></label>
                        <input type="url" id="buttonLink" placeholder="https://example.com">
                    </div>

                    <div class="mb-4">
                        <label for="buttonTarget" class="block text-sm font-medium mb-2" data-i18n="linkTarget"></label>
                        <select id="buttonTarget">
                            <option value="_self" data-i18n="openInSameTab"></option>
                            <option value="_blank" data-i18n="openInNewTab"></option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="buttonImage" class="block text-sm font-medium mb-2" data-i18n="imageIcon"></label>
                        <input type="file" id="buttonImage" accept="image/*" class="mb-2">
                        <img id="currentButtonImagePreview" src="" alt="Current Icon" class="w-20 h-20 object-contain rounded-md border border-gray-600">
                        <button id="clearButtonImage" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md mt-2" data-i18n="clearImage"></button>
                    </div>
                    <div class="mb-4">
                        <label for="buttonColor" class="block text-sm font-medium mb-2" data-i18n="buttonColor"></label>
                        <input type="color" id="buttonColor" class="h-10 w-full p-0 border-none cursor-pointer">
                    </div>
                    <div class="mb-4">
                        <label for="buttonSize" class="block text-sm font-medium mb-2" data-i18n="buttonSize"></label>
                        <select id="buttonSize">
                            <option value="1x1" data-i18n="standard1x1"></option>
                            <option value="2x1" data-i18n="wide2x1"></option>
                            <option value="1x2" data-i18n="tall1x2"></option>
                            <option value="2x2" data-i18n="large2x2"></option>
                            <option value="3x1" data-i18n="veryWide3x1"></option>
                            <option value="1x3" data-i18n="veryTall1x3"></option>
                        </select>
                    </div>
                    </div>
            </div>

            <div id="settingsButtonSettingsSubmenu" class="hidden settings-submenu">
                <button class="back-to-main-menu-button" data-i18n="back"></button>
                <h3 class="text-xl font-semibold mb-3" data-i18n="settingsButtonSettings"></h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2" data-i18n="position"></label>
                    <div class="flex flex-wrap gap-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="settingsButtonPosition" value="top-left" class="form-radio text-blue-600" id="btnPosTL">
                            <span class="ml-2" data-i18n="topLeft"></span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="settingsButtonPosition" value="top-right" class="form-radio text-blue-600" id="btnPosTR">
                            <span class="ml-2" data-i18n="topRight"></span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="settingsButtonPosition" value="bottom-left" class="form-radio text-blue-600" id="btnPosBL">
                            <span class="ml-2" data-i18n="bottomLeft"></span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="settingsButtonPosition" value="bottom-right" class="form-radio text-blue-600" id="btnPosBR">
                            <span class="ml-2" data-i18n="bottomRight"></span>
                        </label>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2" data-i18n="display"></label>
                    <div class="flex flex-wrap gap-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="settingsButtonDisplay" value="text" class="form-radio text-blue-600" id="btnDisplayTxt">
                            <span class="ml-2" data-i18n="text"></span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="settingsButtonDisplay" value="icon" class="form-radio text-blue-600" id="btnDisplayIcon">
                            <span class="ml-2" data-i18n="cogIcon"></span>
                        </label>
                    </div>
                </div>
            </div>

            <div id="languageSettingsSubmenu" class="hidden settings-submenu">
                <button class="back-to-main-menu-button" data-i18n="back"></button>
                <h3 class="text-xl font-semibold mb-3" data-i18n="languageSettings"></h3>
                <div class="mb-4">
                    <label for="languageSelect" class="block text-sm font-medium mb-2" data-i18n="selectLanguage"></label>
                    <select id="languageSelect">
                        <option value="de">Deutsch</option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>

            <div id="backupRestoreSettingsSubmenu" class="hidden settings-submenu">
                <button class="back-to-main-menu-button" data-i18n="back"></button>
                <h3 class="text-xl font-semibold mb-3" data-i18n="backupRestoreData"></h3>
                <div class="mb-4">
                    <button id="exportSettingsButton" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md w-full mb-2" data-i18n="exportSettings"></button>
                </div>
                <div class="mb-4">
                    <label for="importSettingsFile" class="block text-sm font-medium mb-2" data-i18n="importSettingsFile"></label>
                    <input type="file" id="importSettingsFile" accept=".json" class="mb-2">
                    <button id="importSettingsButton" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md w-full" data-i18n="import"></button>
                </div>
                <div class="mb-4">
                    <button id="resetSettingsButton" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md w-full" data-i18n="resetToDefaults"></button>
                </div>
                <div id="importMessage" class="text-sm text-red-400 mt-2"></div>
            </div>


            <div class="flex justify-end gap-4 mt-6">
                <button id="cancelSettings" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md" data-i18n="cancel"></button>
                <button id="saveSettings" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md" data-i18n="save"></button>
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4 text-center" id="confirmationMessage"></h3>
            <div class="flex justify-end gap-4 mt-6">
                <button id="confirmNoButton" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md" data-i18n="no"></button>
                <button id="confirmYesButton" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md" data-i18n="yes"></button>
            </div>
        </div>
    </div>

    <script>
        // Available fonts
        const availableFonts = [
            { name: 'Inter', value: 'Inter, sans-serif' },
            { name: 'Arial', value: 'Arial, sans-serif' },
            { name: 'Verdana', value: 'Verdana, sans-serif' },
            { name: 'Georgia', value: 'Georgia, serif' },
            { name: 'Times New Roman', value: '"Times New Roman", serif' },
            { name: 'Courier New', value: '"Courier New", monospace' }
        ];

        // Default buttons if no settings are saved yet (12x 1x1)
        const defaultButtons = [
            { id: 'btn1', title: 'Google', link: 'https://www.google.com', image: 'https://placehold.co/80x80/4285F4/FFFFFF?text=G', color: '#4285F4', size: '1x1', target: '_self' },
            { id: 'btn2', title: 'YouTube', link: 'https://www.youtube.com', image: 'https://placehold.co/80x80/FF0000/FFFFFF?text=YT', color: '#FF0000', size: '1x1', target: '_self' },
            { id: 'btn3', title: 'Wikipedia', link: 'https://www.wikipedia.org', image: 'https://placehold.co/80x80/000000/FFFFFF?text=W', color: '#000000', size: '1x1', target: '_self' },
            { id: 'btn4', title: 'GitHub', link: 'https://github.com', image: 'https://placehold.co/80x80/181717/FFFFFF?text=GH', color: '#181717', size: '1x1', target: '_self' },
            { id: 'btn5', title: 'News', link: 'https://news.google.com', image: 'https://placehold.co/80x80/34A853/FFFFFF?text=News', color: '#34A853', size: '1x1', target: '_self' },
            { id: 'btn6', title: 'Email', link: 'https://mail.google.com', image: 'https://placehold.co/80x80/EA4335/FFFFFF?text=Mail', color: '#EA4335', size: '1x1', target: '_self' },
            { id: 'btn7', title: 'Spotify', link: 'https://open.spotify.com', image: 'https://placehold.co/80x80/1DB954/FFFFFF?text=S', color: '#1DB954', size: '1x1', target: '_self' },
            { id: 'btn8', title: 'Amazon', link: 'https://www.amazon.de', image: 'https://placehold.co/80x80/FF9900/FFFFFF?text=A', color: '#FF9900', size: '1x1', target: '_self' },
            { id: 'btn9', title: 'Twitter/X', link: 'https://twitter.com', image: 'https://placehold.co/80x80/000000/FFFFFF?text=X', color: '#000000', size: '1x1', target: '_self' },
            { id: 'btn10', title: 'LinkedIn', link: 'https://www.linkedin.com', image: 'https://placehold.co/80x80/0A66C2/FFFFFF?text=LI', color: '#0A66C2', size: '1x1', target: '_self' },
            { id: 'btn11', title: 'Reddit', link: 'https://www.reddit.com', image: 'https://placehold.co/80x80/FF4500/FFFFFF?text=R', color: '#FF4500', size: '1x1', target: '_self' },
            { id: 'btn12', title: 'ChatGPT', link: 'https://chat.openai.com', image: 'https://placehold.co/80x80/10A37F/FFFFFF?text=AI', color: '#10A37F', size: '1x1', target: '_self' }
        ];

        // Search provider URLs
        const searchProviders = {
            google: 'https://www.google.com/search?q=',
            bing: 'https://www.bing.com/search?q=',
            duckduckgo: 'https://www.duckduckgo.com/?q=',
            ecosia: 'https://www.ecosia.org/search?q=',
            wikipedia: 'https://de.wikipedia.org/wiki/Spezial:Suche?search='
        };

        // Search placeholder texts
        const searchPlaceholders = {
            google: 'Search with Google...',
            bing: 'Search with Bing...',
            duckduckgo: 'Search with DuckDuckGo...',
            ecosia: 'Search with Ecosia...',
            wikipedia: 'Search with Wikipedia...'
        };

        // Translation object
        const translations = {
            de: {
                pageTitleDefault: 'Willkommen auf deiner Startseite',
                browserTabTitleDefault: 'Meine Startseite',
                settings: 'Einstellungen',
                modalTitle: 'Einstellungen anpassen',
                backgroundSettings: 'Hintergrund Einstellungen',
                pageTitleSettings: 'Seiten-Titel Einstellungen',
                searchBarSettings: 'Suchleiste Einstellungen',
                gridSettings: 'Raster-Einstellungen',
                manageButtons: 'Buttons verwalten',
                settingsButtonSettings: 'Einstellungen Button',
                languageSettings: 'Sprach Einstellungen',
                backupRestoreData: 'Daten sichern/wiederherstellen',
                back: 'Zurück',
                backgroundType: 'Hintergrundtyp:',
                solidColorBackground: 'Einfarbiger Hintergrund',
                imageBackground: 'Bild Hintergrund',
                gradientBackground: 'Farbverlauf Hintergrund',
                backgroundColor: 'Hintergrundfarbe:',
                selectImageFromFile: 'Bild vom PC auswählen:',
                imageUrl: 'Bildlink (URL):',
                gradientColor1: 'Verlaufsfarbe 1:',
                gradientColor2: 'Verlaufsfarbe 2:',
                gradientDirection: 'Verlaufsrichtung:',
                toRight: 'Nach rechts',
                toBottom: 'Nach unten',
                toBottomRight: 'Nach unten rechts',
                toBottomLeft: 'Nach unten links',
                toTop: 'Nach oben',
                toTopRight: 'Nach oben rechts',
                toTopLeft: 'Nach oben links',
                pageTitle: 'Titel der Seite:',
                yourPageTitle: 'Dein Seiten-Titel',
                titleFont: 'Schriftart des Titels:',
                hidePageTitle: 'Seiten-Titel ausblenden',
                tabTitle: 'Titel der Tableiste:',
                browserTabTitle: 'Titel des Browser-Tabs',
                selectFavicon: 'Favicon auswählen (.ico, .png, .gif):',
                defaultSearchProvider: 'Standardsuchanbieter:',
                maxColumns: 'Maximale Spalten:',
                baseTileHeight: 'Grundhöhe der Kachel (1x1 in px):',
                addButton: 'Button hinzufügen',
                removeSelectedButton: 'Ausgewählten Button entfernen',
                selectButtonToEdit: 'Button zum Bearbeiten auswählen:',
                title: 'Titel',
                titleHiddenIfImage: '(wird ausgeblendet, wenn Bild vorhanden)',
                buttonTitle: 'Button Titel',
                linkUrl: 'Verlinkung (URL):',
                linkTarget: 'Link-Ziel:',
                openInSameTab: 'Im selben Tab öffnen',
                openInNewTab: 'In neuem Tab öffnen',
                imageIcon: 'Bild/Icon (Datei auswählen):',
                clearImage: 'Bild löschen',
                buttonColor: 'Button Farbe:',
                buttonSize: 'Button Größe:',
                standard1x1: 'Standard (1x1)',
                wide2x1: 'Breit (2x1)',
                tall1x2: 'Hoch (1x2)',
                large2x2: 'Groß (2x2)',
                veryWide3x1: 'Sehr Breit (3x1)',
                veryTall1x3: 'Sehr Hoch (1x3)',
                position: 'Position:',
                topLeft: 'Oben Links',
                topRight: 'Oben Rechts',
                bottomLeft: 'Unten Links',
                bottomRight: 'Unten Rechts',
                display: 'Anzeige:',
                text: 'Text',
                cogIcon: 'Zahnradsymbol',
                selectLanguage: 'Sprache auswählen:',
                exportSettings: 'Einstellungen exportieren',
                importSettingsFile: 'Einstellungen importieren (JSON-Datei):',
                import: 'Importieren',
                resetToDefaults: 'Auf Ursprungszustand zurücksetzen',
                cancel: 'Abbrechen',
                save: 'Speichern',
                confirmReset: 'Möchten Sie wirklich alle Einstellungen auf den Ursprungszustand zurücksetzen? Dies kann nicht rückgängig gemacht werden.',
                settingsImported: 'Einstellungen erfolgreich importiert! Die Seite wird neu geladen...',
                invalidFileFormat: 'Ungültiges Dateiformat. Bitte wählen Sie eine gültige Einstellungen-JSON-Datei.',
                errorReadingFile: 'Fehler beim Lesen der Datei. Stellen Sie sicher, dass es eine gültige JSON-Datei ist.',
                settingsReset: 'Einstellungen zurückgesetzt! Die Seite wird neu geladen...',
                yes: 'Ja',
                no: 'Nein',
                pleaseSelectJson: 'Bitte wählen Sie eine JSON-Datei aus.',
                importingSettings: 'Import wird gestartet... Bitte warten.'
            },
            en: {
                pageTitleDefault: 'Welcome to your Startpage',
                browserTabTitleDefault: 'My Startpage',
                settings: 'Settings',
                modalTitle: 'Customize Settings',
                backgroundSettings: 'Background Settings',
                pageTitleSettings: 'Page Title Settings',
                searchBarSettings: 'Search Bar Settings',
                gridSettings: 'Grid Settings',
                manageButtons: 'Manage Buttons',
                settingsButtonSettings: 'Settings Button',
                languageSettings: 'Language Settings',
                backupRestoreData: 'Backup/Restore Data',
                back: 'Back',
                backgroundType: 'Background Type:',
                solidColorBackground: 'Solid Color Background',
                imageBackground: 'Image Background',
                gradientBackground: 'Gradient Background',
                backgroundColor: 'Background Color:',
                selectImageFromFile: 'Select image from PC:',
                imageUrl: 'Image URL:',
                gradientColor1: 'Gradient Color 1:',
                gradientColor2: 'Gradient Color 2:',
                gradientDirection: 'Gradient Direction:',
                toRight: 'To Right',
                toBottom: 'To Bottom',
                toBottomRight: 'To Bottom Right',
                toBottomLeft: 'To Bottom Left',
                toTop: 'To Top',
                toTopRight: 'To Top Right',
                toTopLeft: 'To Top Left',
                pageTitle: 'Page Title:',
                yourPageTitle: 'Your Page Title',
                titleFont: 'Title Font:',
                hidePageTitle: 'Hide Page Title',
                tabTitle: 'Tab Title:',
                browserTabTitle: 'Browser Tab Title',
                selectFavicon: 'Select Favicon (.ico, .png, .gif):',
                defaultSearchProvider: 'Default Search Provider:',
                maxColumns: 'Maximum Columns:',
                baseTileHeight: 'Base Tile Height (1x1 in px):',
                addButton: 'Add Button',
                removeSelectedButton: 'Remove Selected Button',
                selectButtonToEdit: 'Select Button to Edit:',
                title: 'Title',
                titleHiddenIfImage: '(will be hidden if image is present)',
                buttonTitle: 'Button Title',
                linkUrl: 'Link (URL):',
                linkTarget: 'Link Target:',
                openInSameTab: 'Open in same tab',
                openInNewTab: 'Open in new tab',
                imageIcon: 'Image/Icon (select file):',
                clearImage: 'Clear Image',
                buttonColor: 'Button Color:',
                buttonSize: 'Button Size:',
                standard1x1: 'Standard (1x1)',
                wide2x1: 'Wide (2x1)',
                tall1x2: 'Tall (1x2)',
                large2x2: 'Large (2x2)',
                veryWide3x1: 'Very Wide (3x1)',
                veryTall1x3: 'Very Tall (1x3)',
                position: 'Position:',
                topLeft: 'Top Left',
                topRight: 'Top Right',
                bottomLeft: 'Bottom Left',
                bottomRight: 'Bottom Right',
                display: 'Display:',
                text: 'Text',
                cogIcon: 'Cog Icon',
                selectLanguage: 'Select Language:',
                exportSettings: 'Export Settings',
                importSettingsFile: 'Import Settings (JSON file):',
                import: 'Import',
                resetToDefaults: 'Reset to Defaults',
                cancel: 'Cancel',
                save: 'Save',
                confirmReset: 'Are you sure you want to reset all settings to their default state? This cannot be undone.',
                settingsImported: 'Settings imported successfully! Page will reload...',
                invalidFileFormat: 'Invalid file format. Please select a valid settings JSON file.',
                errorReadingFile: 'Error reading file. Make sure it is a valid JSON file.',
                settingsReset: 'Settings reset! Page will reload...',
                yes: 'Yes',
                no: 'No',
                pleaseSelectJson: 'Please select a JSON file.',
                importingSettings: 'Import starting... Please wait.'
            }
        };

        // References to DOM elements (initialized in init())
        let settingsButton;
        let toggleLockButtonsButton;
        let controlButtonsContainer;
        let searchIcon; // Reference to the new search icon

        const body = document.body;
        const mainContentWrapper = document.getElementById('mainContentWrapper');
        const pageTitleElement = document.getElementById('pageTitle');
        const tilesContainer = document.getElementById('tilesContainer');
        const settingsModal = document.getElementById('settingsModal');
        const cancelSettingsButton = document.getElementById('cancelSettings');
        const saveSettingsButton = document.getElementById('saveSettings');
        const buttonSelect = document.getElementById('buttonSelect');
        const buttonEditForm = document.getElementById('buttonEditForm');
        const buttonTitleInput = document.getElementById('buttonTitle');
        const buttonLinkInput = document.getElementById('buttonLink');
        const buttonTargetSelect = document.getElementById('buttonTarget');
        const buttonImageInput = document.getElementById('buttonImage');
        const clearButtonImage = document.getElementById('clearButtonImage');
        const buttonColorInput = document.getElementById('buttonColor');
        const buttonSizeSelect = document.getElementById('buttonSize');
        const googleSearchInput = document.getElementById('googleSearchInput');
        const quickSearchProviderSelect = document.getElementById('quickSearchProviderSelect');
        const currentButtonImagePreview = document.getElementById('currentButtonImagePreview');
        const faviconLink = document.getElementById('faviconLink');
        const faviconFileInput = document.getElementById('faviconFileInput');
        const faviconPreview = document.getElementById('faviconPreview');

        const pageTitleInput = document.getElementById('pageTitleInput');
        const hidePageTitleCheckbox = document.getElementById('hidePageTitleCheckbox');
        const tabTitleInput = document.getElementById('tabTitleInput');
        const searchProviderSelect = document.getElementById('searchProviderSelect');
        const addButton = document.getElementById('addButton');
        const removeButton = document.getElementById('removeButton');
        const searchBarContainer = document.getElementById('searchBarContainer');

        const backgroundTypeSelect = document.getElementById('backgroundTypeSelect');
        const backgroundColorOptions = document.getElementById('backgroundColorOptions');
        const bgColorPicker = document.getElementById('bgColorPicker');
        const backgroundImageOptions = document.getElementById('backgroundImageOptions');
        const backgroundImageFile = document.getElementById('backgroundImageFile');
        const backgroundImageUrl = document.getElementById('backgroundImageUrl');
        const currentBackgroundPreview = document.getElementById('currentBackgroundPreview');
        const backgroundGradientOptions = document.getElementById('backgroundGradientOptions');
        const gradientColor1 = document.getElementById('gradientColor1');
        const gradientColor2 = document.getElementById('gradientColor2');
        const gradientDirection = document.getElementById('gradientDirection');

        const pageTitleFontSelect = document.getElementById('pageTitleFontSelect');

        const maxColumnsInput = document.getElementById('maxColumnsInput');
        const baseTileHeightInput = document.getElementById('baseTileHeightInput');

        const mainSettingsMenu = document.getElementById('mainSettingsMenu');
        const backgroundSettingsSubmenu = document.getElementById('backgroundSettingsSubmenu');
        const pageTitleSettingsSubmenu = document.getElementById('pageTitleSettingsSubmenu');
        const searchBarSettingsSubmenu = document.getElementById('searchBarSettingsSubmenu');
        const gridSettingsSubmenu = document.getElementById('gridSettingsSubmenu');
        const buttonManagementSubmenu = document.getElementById('buttonManagementSubmenu');
        const settingsButtonSettingsSubmenu = document.getElementById('settingsButtonSettingsSubmenu');
        const languageSettingsSubmenu = document.getElementById('languageSettingsSubmenu'); // New language submenu
        const backupRestoreSettingsSubmenu = document.getElementById('backupRestoreSettingsSubmenu');

        const openBackgroundSettingsButton = document.getElementById('openBackgroundSettings');
        const openPageTitleSettingsButton = document.getElementById('openPageTitleSettings');
        const openSearchBarSettingsButton = document.getElementById('openSearchBarSettings');
        const openGridSettingsButton = document.getElementById('openGridSettings');
        const openButtonManagementButton = document.getElementById('openButtonManagement');
        const openSettingsButtonSettingsButton = document.getElementById('openSettingsButtonSettings');
        const openLanguageSettingsButton = document.getElementById('openLanguageSettings'); // New language settings button
        const openBackupRestoreSettingsButton = document.getElementById('openBackupRestoreSettings');

        const backToMainMenuButtons = document.querySelectorAll('.back-to-main-menu-button');

        const settingsButtonPositionRadios = document.querySelectorAll('input[name="settingsButtonPosition"]');
        const settingsButtonDisplayRadios = document.querySelectorAll('input[name="settingsButtonDisplay"]');

        const languageSelect = document.getElementById('languageSelect'); // New language select

        const exportSettingsButton = document.getElementById('exportSettingsButton');
        const importSettingsFile = document.getElementById('importSettingsFile');
        const importSettingsButton = document.getElementById('importSettingsButton');
        const importMessage = document.getElementById('importMessage');
        const resetSettingsButton = document.getElementById('resetSettingsButton');

        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmYesButton = document.getElementById('confirmYesButton');
        const confirmNoButton = document.getElementById('confirmNoButton');


        let currentButtons = [];
        let currentBackgroundColor = '#1a202c';
        let currentPageTitle = ''; // Will be set by localization
        let hidePageTitle = false;
        let currentTabTitle = ''; // Will be set by localization
        let currentDefaultSearchProvider = 'google';
        let currentActiveSearchProvider = 'google';
        let currentFaviconBase64 = '';
        let selectedFileBase64 = null;

        let currentBackgroundType = 'color';
        let currentBackgroundImageUrl = '';
        let currentBackgroundImageBase64 = '';
        let currentGradientColor1 = '#4F46E5';
        let currentGradientColor2 = '#EC4899';
        let currentGradientDirection = 'to right';

        let currentPageTitleFont = 'Inter, sans-serif';

        let currentMaxColumns = 6;
        let currentBaseTileHeight = 150;

        let currentSettingsButtonPosition = 'bottom-right';
        let currentSettingsButtonDisplay = 'text';

        let currentLanguage = 'de'; // Default language

        let areButtonsLocked = true; // Set default to locked

        // Global variable for the line indicator
        let lineIndicator = null;

        // Function to set the language of the UI
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('browserStartPageLanguage', lang);
            document.documentElement.lang = lang; // Set HTML lang attribute

            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });

            // Update all elements with data-i18n-placeholder attribute
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[lang] && translations[lang][key]) {
                    element.placeholder = translations[lang][key];
                }
            });

            // Update hardcoded texts not covered by data-i18n
            pageTitleElement.textContent = currentPageTitle || translations[currentLanguage].pageTitleDefault;
            document.title = currentTabTitle || translations[currentLanguage].browserTabTitleDefault;
            settingsButton.textContent = translations[currentLanguage].settings;
            document.getElementById('modalTitle').textContent = translations[currentLanguage].modalTitle;

            // Update placeholder for search input based on current active search provider and selected language
            googleSearchInput.placeholder = searchPlaceholders[currentActiveSearchProvider];

            // Re-render buttons to ensure their titles are updated if they refer to translations
            renderButtons();
        }

        // Function to load settings from Local Storage
        function loadSettings() {
            try {
                const storedButtons = localStorage.getItem('browserStartPageButtons');
                const storedBgColor = localStorage.getItem('browserStartPageBgColor');
                const storedPageTitle = localStorage.getItem('browserStartPageTitle');
                const storedHidePageTitle = localStorage.getItem('browserStartPageHideTitle');
                const storedTabTitle = localStorage.getItem('browserStartPageTabTitle');
                const storedDefaultSearchProvider = localStorage.getItem('browserStartPageSearchProvider');
                const storedBackgroundType = localStorage.getItem('browserStartPageBackgroundType');
                const storedBackgroundImageUrl = localStorage.getItem('browserStartPageBackgroundImageUrl');
                const storedBackgroundImageBase64 = localStorage.getItem('browserStartPageBackgroundImageBase64');
                const storedGradientColor1 = localStorage.getItem('browserStartPageGradientColor1');
                const storedGradientColor2 = localStorage.getItem('browserStartPageGradientGradientColor2');
                const storedGradientDirection = localStorage.getItem('browserStartPageGradientGradientDirection');
                const storedPageTitleFont = localStorage.getItem('browserStartPageTitleFont');
                const storedMaxColumns = localStorage.getItem('browserStartPageMaxColumns');
                const storedBaseTileHeight = localStorage.getItem('browserStartPageBaseTileHeight');
                const storedSettingsButtonPosition = localStorage.getItem('browserStartPageSettingsButtonPosition');
                const storedSettingsButtonDisplay = localStorage.getItem('browserStartPageSettingsButtonDisplay');
                const storedFaviconBase64 = localStorage.getItem('browserStartPageFavicon');
                const storedLanguage = localStorage.getItem('browserStartPageLanguage');

                currentButtons = storedButtons ? JSON.parse(storedButtons) : JSON.parse(JSON.stringify(defaultButtons));
                currentBackgroundColor = storedBgColor || '#1a202c';
                currentPageTitle = storedPageTitle !== null ? storedPageTitle : ''; // Set by localization
                hidePageTitle = storedHidePageTitle === 'true';
                currentTabTitle = storedTabTitle !== null ? storedTabTitle : ''; // Set by localization
                currentDefaultSearchProvider = storedDefaultSearchProvider || 'google';
                currentActiveSearchProvider = currentDefaultSearchProvider;
                currentFaviconBase64 = storedFaviconBase64 || '';
                areButtonsLocked = true; // ALWAYS set to locked on load

                currentBackgroundType = storedBackgroundType || 'color';
                currentBackgroundImageUrl = storedBackgroundImageUrl || '';
                currentBackgroundImageBase64 = '';
                if (storedBackgroundImageBase64) {
                    currentBackgroundImageBase64 = storedBackgroundImageBase64;
                } else if (storedBackgroundImageUrl) {
                    currentBackgroundImageUrl = storedBackgroundImageUrl;
                }

                currentGradientColor1 = storedGradientColor1 || '#4F46E5';
                currentGradientColor2 = storedGradientColor2 || '#EC4899';
                currentGradientDirection = storedGradientDirection || 'to right';

                currentPageTitleFont = storedPageTitleFont || 'Inter, sans-serif';

                currentMaxColumns = parseInt(storedMaxColumns) || 6;
                currentBaseTileHeight = parseInt(storedBaseTileHeight) || 150;

                currentSettingsButtonPosition = storedSettingsButtonPosition || 'bottom-right';
                currentSettingsButtonDisplay = storedSettingsButtonDisplay || 'text';

                currentLanguage = storedLanguage || 'de'; // Load saved language, default to German

                // Update quickSearchProviderSelect value
                quickSearchProviderSelect.value = currentActiveSearchProvider;

                // Ensure button structure consistency
                currentButtons = currentButtons.map(btn => ({
                    ...btn,
                    id: btn.id || 'btn' + Math.random().toString(36).substr(2, 9),
                    size: btn.size || '1x1',
                    target: btn.target || '_self',
                }));

                if (currentButtons.length === 0) {
                    currentButtons = JSON.parse(JSON.stringify(defaultButtons));
                }

            } catch (e) {
                console.error("Error loading settings from Local Storage:", e);
                // Reset to default values in case of error
                currentButtons = JSON.parse(JSON.stringify(defaultButtons));
                currentBackgroundColor = '#1a202c';
                currentPageTitle = ''; // Set by localization
                hidePageTitle = false;
                currentTabTitle = ''; // Set by localization
                currentDefaultSearchProvider = 'google';
                currentActiveSearchProvider = 'google';
                currentFaviconBase64 = '';
                currentBackgroundType = 'color';
                currentBackgroundImageUrl = '';
                currentBackgroundImageBase64 = '';
                currentGradientColor1 = '#4F46E5';
                currentGradientColor2 = '#EC4899';
                currentGradientDirection = 'to right';
                currentPageTitleFont = 'Inter, sans-serif';
                currentMaxColumns = 6;
                currentBaseTileHeight = 150;
                currentSettingsButtonPosition = 'bottom-right';
                currentSettingsButtonDisplay = 'text';
                currentLanguage = 'de'; // Default to German
                areButtonsLocked = true; // ALWAYS set to locked
            }
        }

        // Function to save settings to Local Storage
        function saveSettings() {
            try {
                localStorage.setItem('browserStartPageButtons', JSON.stringify(currentButtons));
                localStorage.setItem('browserStartPageBgColor', currentBackgroundColor);
                localStorage.setItem('browserStartPageTitle', currentPageTitle);
                localStorage.setItem('browserStartPageHideTitle', hidePageTitle);
                localStorage.setItem('browserStartPageTabTitle', currentTabTitle);
                localStorage.setItem('browserStartPageSearchProvider', currentDefaultSearchProvider);
                localStorage.setItem('browserStartPageFavicon', currentFaviconBase64);
                // areButtonsLocked is NOT saved here to avoid persisting the state

                localStorage.setItem('browserStartPageBackgroundType', currentBackgroundType);
                localStorage.setItem('browserStartPageBackgroundImageUrl', currentBackgroundImageUrl);
                localStorage.setItem('browserStartPageBackgroundImageBase64', currentBackgroundImageBase64);
                localStorage.setItem('browserStartPageGradientColor1', currentGradientColor1);
                localStorage.setItem('browserStartPageGradientColor2', currentGradientColor2);
                localStorage.setItem('browserStartPageGradientDirection', currentGradientDirection);

                localStorage.setItem('browserStartPageTitleFont', currentPageTitleFont);

                localStorage.setItem('browserStartPageMaxColumns', currentMaxColumns);
                localStorage.setItem('browserStartPageBaseTileHeight', currentBaseTileHeight);

                localStorage.setItem('browserStartPageSettingsButtonPosition', currentSettingsButtonPosition);
                localStorage.setItem('browserStartPageSettingsButtonDisplay', currentSettingsButtonDisplay);

                localStorage.setItem('browserStartPageLanguage', currentLanguage); // Save selected language

            } catch (e) {
                console.error("Error saving settings to Local Storage:", e);
            }
        }

        // Function to render buttons on the page
        function renderButtons() {
            // Remove all existing tile elements (but not the lineIndicator)
            const existingTiles = Array.from(tilesContainer.children).filter(
                child => child.classList.contains('tile')
            );
            existingTiles.forEach(tile => tilesContainer.removeChild(tile));

            currentButtons.forEach(button => {
                const tile = document.createElement('a');
                tile.href = button.link;
                tile.target = button.target || '_self';
                tile.className = `tile hover:scale-105 hover:shadow-lg rounded-xl`;
                tile.setAttribute('data-id', button.id);
                tile.setAttribute('data-size', button.size);

                tile.style.backgroundColor = button.color;

                tile.draggable = !areButtonsLocked;

                if (!areButtonsLocked) {
                    tile.addEventListener('dragstart', handleDragStart);
                    tile.addEventListener('click', (e) => {
                        if (!areButtonsLocked) {
                            e.preventDefault(); // Prevent navigation when buttons are unlocked (for drag/drop)
                        }
                    });
                }

                const img = document.createElement('img');
                img.src = button.image;
                img.alt = button.title + ' Icon';

                const title = document.createElement('h3');
                title.textContent = button.title;
                title.classList.add('hidden'); // Hide by default, show if no image

                tile.appendChild(img);
                tile.appendChild(title);

                const isPlaceholderImage = !button.image ||
                                           button.image.includes('placehold.co/80x80/6B7280/FFFFFF?text=Icon') ||
                                           button.image.includes('placehold.co/80x80/6B7280/FFFFFF?text=New');

                if (isPlaceholderImage) {
                    title.classList.remove('hidden');
                    img.remove();
                } else {
                    img.onload = () => {
                        title.classList.add('hidden');
                    };
                    img.onerror = function() {
                        this.remove(); // Remove broken image
                        title.classList.remove('hidden'); // Show title instead
                    };
                }

                tilesContainer.appendChild(tile);
            });

            // Ensure the lineIndicator is always the last child (for correct z-index)
            if (lineIndicator && tilesContainer.lastChild !== lineIndicator) {
                tilesContainer.appendChild(lineIndicator);
            }
        }

        // Drag & Drop Handler Functions
        let draggedItemId = null;
        let draggedItemSize = '1x1';

        function handleDragStart(e) {
            if (areButtonsLocked) {
                e.preventDefault();
                return;
            }
            draggedItemId = e.target.dataset.id;
            draggedItemSize = e.target.dataset.size;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedItemId);
            setTimeout(() => {
                const originalDraggedElement = document.querySelector(`.tile[data-id="${draggedItemId}"]`);
                if (originalDraggedElement) {
                    originalDraggedElement.classList.add('opacity-0');
                }
            }, 0);

            // Make the line indicator visible
            lineIndicator.style.display = 'block';

            // Add drag-active class to tilesContainer
            tilesContainer.classList.add('drag-active');
        }

        function handleDragOver(e) {
            if (areButtonsLocked) return;
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const originalDraggedElement = document.querySelector(`.tile[data-id="${draggedItemId}"]`);
            const currentTilesInDOM = Array.from(tilesContainer.children).filter(
                child => child.nodeType === Node.ELEMENT_NODE && child.classList.contains('tile') && child !== originalDraggedElement && child !== lineIndicator
            );

            const tilesContainerRect = tilesContainer.getBoundingClientRect();
            const computedStyle = getComputedStyle(tilesContainer);
            const gap = parseFloat(computedStyle.gap);
            const baseTileHeight = parseFloat(computedStyle.getPropertyValue('--base-tile-height'));
            const lineHalfWidth = lineIndicator.offsetWidth / 2;

            let insertIndex = currentButtons.length; // Default to inserting at the very end
            let lineLeft = 0;
            let lineTop = 0;
            let lineHeight = baseTileHeight; // Default height for the indicator

            let closestTile = null;
            let minDistance = Infinity;

            // Find the visually closest tile that is NOT the dragged element or the indicator itself
            for (let i = 0; i < currentTilesInDOM.length; i++) {
                const tile = currentTilesInDOM[i];
                const rect = tile.getBoundingClientRect();

                // Calculate distance from mouse to center of tile
                const tileCenterX = rect.left + rect.width / 2;
                const tileCenterY = rect.top + rect.height / 2;
                const distance = Math.sqrt(Math.pow(e.clientX - tileCenterX, 2) + Math.pow(e.clientY - tileCenterY, 2));

                if (distance < minDistance) {
                    minDistance = distance;
                    closestTile = tile;
                }
            }

            if (closestTile) {
                const rect = closestTile.getBoundingClientRect();
                // Positions relative to tilesContainer's top-left corner
                const tileRelativeLeft = rect.left - tilesContainerRect.left;
                const tileRelativeTop = rect.top - tilesContainerRect.top;

                const insertBefore = e.clientX < rect.left + rect.width / 2;
                const closestTileLogicalIndex = currentButtons.findIndex(btn => btn.id === closestTile.dataset.id);

                lineTop = tileRelativeTop;
                lineHeight = rect.height;

                if (insertBefore) {
                    lineLeft = tileRelativeLeft - (gap / 2) - lineHalfWidth;
                    insertIndex = closestTileLogicalIndex;
                } else {
                    lineLeft = tileRelativeLeft + rect.width + (gap / 2) - lineHalfWidth;
                    insertIndex = closestTileLogicalIndex + 1;
                }

            } else {
                // If no closest tile found, determine if it's at the beginning or end of the grid.
                const paddingLeft = parseFloat(computedStyle.paddingLeft);
                const paddingTop = parseFloat(computedStyle.paddingTop);

                // Mouse position relative to the tilesContainer
                const mouseXRelativeToContainer = e.clientX - tilesContainerRect.left;
                const mouseYRelativeToContainer = e.clientY - tilesContainerRect.top;

                // If the grid is empty, always place at the very beginning
                if (currentTilesInDOM.length === 0) {
                    lineLeft = paddingLeft - lineHalfWidth;
                    lineTop = paddingTop;
                    lineHeight = baseTileHeight;
                    insertIndex = 0;
                } else {
                    // Grid is not empty, but mouse is not over an existing tile.
                    // Decide if it's logically before the first tile or after the last tile.
                    const firstTile = currentTilesInDOM[0];
                    const firstTileRect = firstTile.getBoundingClientRect();
                    const lastTile = currentTilesInDOM[currentTilesInDOM.length - 1];
                    const lastTileRect = lastTile.getBoundingClientRect();

                    const firstTileRelativeLeft = firstTileRect.left - tilesContainerRect.left;
                    const firstTileRelativeTop = firstTileRect.top - tilesContainerRect.top;
                    const lastTileRelativeLeft = lastTileRect.left - tilesContainerRect.left;
                    const lastTileRelativeTop = lastTileRect.top - tilesContainerRect.top;

                    // Calculate logical row/column based on mouse position
                    const currentMouseRow = Math.floor((mouseYRelativeToContainer - paddingTop) / (baseTileHeight + gap));
                    const currentMouseCol = Math.floor((mouseXRelativeToContainer - paddingLeft) / (baseTileHeight + gap));

                    // Find the last occupied row and column
                    let lastOccupiedRow = 0;
                    let lastOccupiedCol = 0;
                    if (currentButtons.length > 0) {
                        const lastButton = currentButtons[currentButtons.length - 1];
                        // This calculation is a bit complex and depends on how your grid is filled.
                        // A simpler approach for visual placement when outside a tile:
                        // If mouse is generally to the left of the first tile
                        if (mouseXRelativeToContainer < firstTileRelativeLeft) {
                            lineLeft = paddingLeft - lineHalfWidth;
                            lineTop = firstTileRelativeTop; // Stay on the first row's level
                            insertIndex = 0;
                        }
                        // If mouse is generally to the right of the last tile
                        else if (mouseXRelativeToContainer > lastTileRelativeLeft + lastTileRect.width) {
                            lineLeft = lastTileRelativeLeft + lastTileRect.width + (gap / 2) - lineHalfWidth;
                            lineTop = lastTileRelativeTop; // Stay on the last row's level
                            insertIndex = currentButtons.length;
                        }
                        // If mouse is within the grid's horizontal bounds but not over a tile,
                        // assume it's at the end of the current row or a new row.
                        else {
                            // This part needs more sophisticated grid-to-index mapping if precise
                            // insertion in empty cells is desired. For now, default to end.
                            lineLeft = lastTileRelativeLeft + lastTileRect.width + (gap / 2) - lineHalfWidth;
                            lineTop = lastTileRelativeTop;
                            insertIndex = currentButtons.length;
                        }
                    } else {
                        // If no tiles at all, place at the very beginning
                        lineLeft = paddingLeft - lineHalfWidth;
                        lineTop = paddingTop;
                        insertIndex = 0;
                    }
                }
            }

            // Ensure insertIndex is within valid bounds of the currentButtons array
            insertIndex = Math.max(0, Math.min(insertIndex, currentButtons.length));

            // Final clamping to ensure indicator stays within tilesContainer's visual boundaries
            const containerPaddingLeft = parseFloat(computedStyle.paddingLeft);
            const containerPaddingRight = parseFloat(computedStyle.paddingRight);
            const containerPaddingTop = parseFloat(computedStyle.paddingTop);
            const containerPaddingBottom = parseFloat(computedStyle.paddingBottom);

            // Use tilesContainerRect.width/height for total dimensions, then subtract padding
            const maxLineLeft = tilesContainerRect.width - containerPaddingRight - lineIndicator.offsetWidth;
            const maxLineTop = tilesContainerRect.height - containerPaddingBottom - lineHeight;

            lineLeft = Math.max(containerPaddingLeft - lineHalfWidth, Math.min(lineLeft, maxLineLeft));
            lineTop = Math.max(containerPaddingTop, Math.min(lineTop, maxLineTop));

            // Apply calculated styles
            // Subtract 2px to shift left, compensating for the observed right shift
            lineIndicator.style.left = `${lineLeft - 2}px`;
            lineIndicator.style.top = `${lineTop}px`;
            lineIndicator.style.height = `${lineHeight}px`;
            lineIndicator.dataset.insertIndex = insertIndex;
        }

        function handleDrop(e) {
            if (areButtonsLocked) return;
            e.preventDefault();

            const originalDraggedElement = document.querySelector(`.tile[data-id="${draggedItemId}"]`);
            if (originalDraggedElement) {
                originalDraggedElement.classList.remove('opacity-0'); // Make it visible again
            }

            // Hide the line indicator
            lineIndicator.style.display = 'none';
            // Remove drag-active class from tilesContainer
            tilesContainer.classList.remove('drag-active');

            const newIndex = parseInt(lineIndicator.dataset.insertIndex);

            if (!isNaN(newIndex)) {
                const draggedItemObject = currentButtons.find(btn => btn.id === draggedItemId);
                if (!draggedItemObject) {
                    console.error("Dragged item not found in currentButtons array.");
                    return;
                }

                const originalIndexInArray = currentButtons.findIndex(btn => btn.id === draggedItemId);
                currentButtons.splice(originalIndexInArray, 1); // Remove from original position

                // Adjust newIndex if the original item was before the new drop position
                let finalIndex = newIndex;
                if (originalIndexInArray < newIndex) {
                    finalIndex--; // If we removed an item before the target, the target index shifts left by 1
                }

                currentButtons.splice(finalIndex, 0, draggedItemObject);

                saveSettings();
                renderButtons(); // Re-render to reflect the new order
            } else {
                console.warn("Drop occurred without a valid insert index. Re-rendering without reordering.");
                renderButtons();
            }

            draggedItemId = null;
            draggedItemSize = '1x1';
        }

        function handleDragLeave(e) {
            if (areButtonsLocked) return;
            // The indicator should only hide on drop or dragend.
        }

        function handleDragEnd(e) {
            if (areButtonsLocked) return;
            const originalDraggedElement = document.querySelector(`.tile[data-id="${draggedItemId}"]`);
            if (originalDraggedElement) {
                originalDraggedElement.classList.remove('opacity-0');
            }
            // Hide the line indicator
            lineIndicator.style.display = 'none';
            draggedItemId = null;
            draggedItemSize = '1x1';

            // Remove drag-active class from tilesContainer
            tilesContainer.classList.remove('drag-active');
        }


        // Function to apply page title settings
        function applyPageTitleSettings() {
            pageTitleElement.textContent = currentPageTitle || translations[currentLanguage].pageTitleDefault;
            pageTitleElement.style.fontFamily = currentPageTitleFont;
            pageTitleElement.style.textShadow = '0 0 5px rgba(0,0,0,0.7)';
            if (hidePageTitle) {
                pageTitleElement.classList.add('hidden');
            } else {
                pageTitleElement.classList.remove('hidden');
            }
        }

        // Function to apply tab title settings
        function applyTabTitleSettings() {
            document.title = currentTabTitle || translations[currentLanguage].browserTabTitleDefault;
        }

        // Function to apply search bar position (simplified)
        function applySearchPosition() {
            // The main content wrapper is already flex-col and items-center justify-center.
            // This ensures the title, search bar, and tiles grid are vertically centered as a block.
            // No specific order or justify-content changes are needed here for the search bar itself,
            // as its position within the main content flow is fixed (after title, before tiles).
        }

        // Function to apply background settings
        function applyBackgroundSettings() {
            body.style.backgroundColor = '';
            body.style.backgroundImage = '';

            if (currentBackgroundType === 'color') {
                body.style.backgroundColor = currentBackgroundColor;
            } else if (currentBackgroundType === 'image') {
                if (currentBackgroundImageBase64) {
                    body.style.backgroundImage = `url(${currentBackgroundImageBase64})`;
                } else if (currentBackgroundImageUrl) {
                    body.style.backgroundImage = `url(${currentBackgroundImageUrl})`;
                }
            } else if (currentBackgroundType === 'gradient') {
                body.style.backgroundImage = `linear-gradient(${currentGradientDirection}, ${currentGradientColor1}, ${currentGradientColor2})`;
            }
        }

        // Function to apply grid settings
        function applyGridSettings() {
            tilesContainer.style.setProperty('--max-cols', currentMaxColumns);

            let maxRowOccupied = 0;
            let currentRow = 0;
            let currentColumn = 0;

            currentButtons.forEach(button => {
                const [width, height] = button.size.split('x').map(Number);

                if (currentColumn + width > currentMaxColumns) {
                    currentRow++;
                    currentColumn = 0;
                }

                maxRowOccupied = Math.max(maxRowOccupied, currentRow + height);

                currentColumn += width;
            });

            const dynamicMaxRows = maxRowOccupied + 1;
            tilesContainer.style.setProperty('--max-rows', dynamicMaxRows);

            tilesContainer.style.setProperty('--base-tile-height', `${currentBaseTileHeight}px`);
        }

        // Function to apply settings button settings
        function applySettingsButton() {
            controlButtonsContainer.classList.remove('container-top-left', 'container-top-right', 'container-bottom-left', 'container-bottom-right');

            controlButtonsContainer.classList.add(`container-${currentSettingsButtonPosition}`);

            controlButtonsContainer.innerHTML = ''; // Clear existing buttons

            // Append buttons based on position to control their order
            if (currentSettingsButtonPosition === 'top-left' || currentSettingsButtonPosition === 'bottom-left') {
                controlButtonsContainer.appendChild(settingsButton);
                controlButtonsContainer.appendChild(toggleLockButtonsButton);
            } else {
                controlButtonsContainer.appendChild(toggleLockButtonsButton);
                controlButtonsContainer.appendChild(settingsButton);
            }

            if (currentSettingsButtonDisplay === 'icon') {
                settingsButton.innerHTML = '<i class="fas fa-cog"></i>';
                settingsButton.classList.add('icon-only');
            } else {
                settingsButton.textContent = translations[currentLanguage].settings; // Localized text
                settingsButton.classList.remove('icon-only');
            }
        }

        // Function to apply lock button state
        function applyToggleLockButtonState() {
            if (areButtonsLocked) {
                toggleLockButtonsButton.innerHTML = '<i class="fas fa-lock"></i>';
                toggleLockButtonsButton.classList.remove('unlocked');
                toggleLockButtonsButton.style.backgroundColor = '#4a5568';
            } else {
                toggleLockButtonsButton.innerHTML = '<i class="fas fa-unlock"></i>';
                toggleLockButtonsButton.classList.add('unlocked');
                toggleLockButtonsButton.style.backgroundColor = '#3B82F6';
            }
            renderButtons(); // Re-render buttons to update draggable attribute
        }

        // Function to apply favicon
        function applyFavicon() {
            if (currentFaviconBase64) {
                faviconLink.href = currentFaviconBase64;
            } else {
                faviconLink.href = '';
            }
        }

        // Function to display the respective menu/submenu in the modal
        function showMenu(menuToShow) {
            mainSettingsMenu.classList.add('hidden');
            backgroundSettingsSubmenu.classList.add('hidden');
            pageTitleSettingsSubmenu.classList.add('hidden');
            searchBarSettingsSubmenu.classList.add('hidden');
            gridSettingsSubmenu.classList.add('hidden');
            buttonManagementSubmenu.classList.add('hidden');
            settingsButtonSettingsSubmenu.classList.add('hidden');
            languageSettingsSubmenu.classList.add('hidden'); // Hide new submenu
            backupRestoreSettingsSubmenu.classList.add('hidden');

            document.getElementById(menuToShow).classList.remove('hidden');
        }

        function openSettingsModal() {
            settingsModal.style.display = 'flex';
            showMenu('mainSettingsMenu'); // Always start with main menu

            populateButtonSelect();
            populateFontSelects();

            bgColorPicker.value = currentBackgroundColor;
            pageTitleInput.value = currentPageTitle;
            hidePageTitleCheckbox.checked = hidePageTitle;
            tabTitleInput.value = currentTabTitle;
            searchProviderSelect.value = currentDefaultSearchProvider;
            pageTitleFontSelect.value = currentPageTitleFont;
            faviconPreview.src = currentFaviconBase64;

            backgroundTypeSelect.value = currentBackgroundType;
            backgroundImageUrl.value = currentBackgroundImageUrl;
            gradientColor1.value = currentGradientColor1;
            gradientColor2.value = currentGradientColor2;
            gradientDirection.value = currentGradientDirection;

            maxColumnsInput.value = currentMaxColumns;
            baseTileHeightInput.value = currentBaseTileHeight;

            settingsButtonPositionRadios.forEach(radio => {
                radio.checked = radio.value === currentSettingsButtonPosition;
            });
            settingsButtonDisplayRadios.forEach(radio => {
                radio.checked = radio.value === currentSettingsButtonDisplay;
            });

            languageSelect.value = currentLanguage; // Set selected language in dropdown

            if (currentBackgroundType === 'image') {
                if (currentBackgroundImageBase64) {
                    currentBackgroundPreview.src = currentBackgroundImageBase64;
                } else if (currentBackgroundImageUrl) {
                    currentBackgroundPreview.src = currentBackgroundImageUrl;
                } else {
                    currentBackgroundPreview.src = '';
                }
            } else {
                currentBackgroundPreview.src = '';
            }
            selectedFileBase64 = null;

            toggleBackgroundOptions();

            buttonSelect.value = '';
            buttonEditForm.classList.add('hidden');
            currentButtonImagePreview.src = '';

            importMessage.textContent = '';
            importSettingsFile.value = '';
        }

        function closeSettingsModal() {
            settingsModal.style.display = 'none';
            cancelSettingsButton.disabled = false;
            saveSettingsButton.disabled = false;
            exportSettingsButton.disabled = false;
            importSettingsButton.disabled = false;
            importSettingsFile.disabled = false;
            resetSettingsButton.disabled = false;
            importMessage.textContent = '';
            importMessage.style.color = '';
        }

        function populateButtonSelect() {
            buttonSelect.innerHTML = `<option value="">- ${translations[currentLanguage].selectButtonToEdit} -</option>`;
            currentButtons.forEach((button) => {
                const option = document.createElement('option');
                option.value = button.id;
                option.textContent = button.title;
                buttonSelect.appendChild(option);
            });
        }

        function populateFontSelects() {
            pageTitleFontSelect.innerHTML = '';
            availableFonts.forEach(font => {
                const option = document.createElement('option');
                option.value = font.value;
                option.textContent = font.name;
                pageTitleFontSelect.appendChild(option);
            });
        }


        function toggleBackgroundOptions() {
            const selectedType = backgroundTypeSelect.value;
            backgroundColorOptions.classList.add('hidden');
            backgroundImageOptions.classList.add('hidden');
            backgroundGradientOptions.classList.add('hidden');

            if (selectedType === 'color') {
                backgroundColorOptions.classList.remove('hidden');
            } else if (selectedType === 'image') {
                backgroundImageOptions.classList.remove('hidden');
            } else if (selectedType === 'gradient') {
                backgroundGradientOptions.classList.remove('hidden');
            }
        }

        backgroundTypeSelect.addEventListener('change', toggleBackgroundOptions);

        backgroundImageFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentBackgroundImageBase64 = e.target.result;
                    currentBackgroundPreview.src = currentBackgroundImageBase64;
                    backgroundImageUrl.value = '';
                };
                reader.readAsDataURL(file);
            } else {
                currentBackgroundImageBase64 = '';
            }
        });

        backgroundImageUrl.addEventListener('input', () => {
            currentBackgroundImageUrl = backgroundImageUrl.value;
            currentBackgroundPreview.src = currentBackgroundImageUrl;
            backgroundImageFile.value = '';
            currentBackgroundImageBase64 = '';
        });

        buttonImageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFileBase64 = e.target.result;
                    currentButtonImagePreview.src = selectedFileBase64;
                };
                reader.readAsDataURL(file);
            } else {
                selectedFileBase64 = null;
            }
        });

        clearButtonImage.addEventListener('click', () => {
            currentButtonImagePreview.src = '';
            buttonImageInput.value = '';
            selectedFileBase64 = '';
        });

        faviconFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentFaviconBase64 = e.target.result;
                    faviconPreview.src = currentFaviconBase64;
                };
            } else {
                currentFaviconBase64 = '';
                faviconPreview.src = '';
            }
        });

        buttonSelect.addEventListener('change', (event) => {
            const selectedId = event.target.value;
            if (selectedId) {
                const selectedButton = currentButtons.find(btn => btn.id === selectedId);
                if (selectedButton) {
                    buttonTitleInput.value = selectedButton.title;
                    buttonLinkInput.value = selectedButton.link;
                    buttonColorInput.value = selectedButton.color;
                    buttonSizeSelect.value = selectedButton.size;
                    buttonTargetSelect.value = selectedButton.target || '_self';

                    buttonImageInput.value = '';
                    currentButtonImagePreview.src = selectedButton.image;
                    selectedFileBase64 = selectedButton.image;

                    buttonEditForm.classList.remove('hidden');
                }
            } else {
                buttonEditForm.classList.add('hidden');
                buttonImageInput.value = '';
                currentButtonImagePreview.src = '';
                selectedFileBase64 = null;
            }
        });

        addButton.addEventListener('click', () => {
            const newId = 'btn' + Date.now();
            const newButton = {
                id: newId,
                title: translations[currentLanguage].buttonTitle, // Localized default title
                link: 'https://www.example.com',
                image: '',
                color: '#6B7280',
                size: '1x1',
                target: '_self',
            };
            currentButtons.push(newButton);
            populateButtonSelect();
            buttonSelect.value = newId;
            buttonSelect.dispatchEvent(new Event('change'));
        });

        removeButton.addEventListener('click', () => {
            const selectedId = buttonSelect.value;
            if (selectedId && currentButtons.length > 0) {
                currentButtons = currentButtons.filter(btn => btn.id !== selectedId);
                populateButtonSelect();
                buttonSelect.value = '';
                buttonEditForm.classList.add('hidden');
                currentButtonImagePreview.src = '';
            } else if (currentButtons.length === 0) {
                console.warn("No buttons to remove.");
            }
        });

        saveSettingsButton.addEventListener('click', () => {
            const selectedId = buttonSelect.value;
            if (selectedId) {
                const buttonIndex = currentButtons.findIndex(btn => btn.id === selectedId);
                if (buttonIndex !== -1) {
                    currentButtons[buttonIndex].title = buttonTitleInput.value;
                    currentButtons[buttonIndex].link = buttonLinkInput.value;
                    currentButtons[buttonIndex].color = buttonColorInput.value;
                    currentButtons[buttonIndex].size = buttonSizeSelect.value;
                    currentButtons[buttonIndex].target = buttonTargetSelect.value;

                    currentButtons[buttonIndex].image = selectedFileBase64 || '';
                }
            }

            currentPageTitle = pageTitleInput.value;
            hidePageTitle = hidePageTitleCheckbox.checked;
            currentTabTitle = tabTitleInput.value;
            currentPageTitleFont = pageTitleFontSelect.value;

            currentDefaultSearchProvider = searchProviderSelect.value;
            currentActiveSearchProvider = currentDefaultSearchProvider;

            currentBackgroundType = backgroundTypeSelect.value;
            if (currentBackgroundType === 'color') {
                currentBackgroundColor = bgColorPicker.value;
                currentBackgroundImageUrl = '';
                currentBackgroundImageBase64 = '';
            } else if (currentBackgroundType === 'image') {
                currentBackgroundColor = '';
            } else if (currentBackgroundType === 'gradient') {
                currentGradientColor1 = gradientColor1.value;
                currentGradientColor2 = gradientColor2.value;
                currentGradientDirection = gradientDirection.value;
                currentBackgroundColor = '';
                currentBackgroundImageUrl = '';
                currentBackgroundImageBase64 = '';
            }

            currentMaxColumns = parseInt(maxColumnsInput.value);
            currentBaseTileHeight = parseInt(baseTileHeightInput.value);

            settingsButtonPositionRadios.forEach(radio => {
                if (radio.checked) {
                    currentSettingsButtonPosition = radio.value;
                }
            });
            settingsButtonDisplayRadios.forEach(radio => {
                if (radio.checked) {
                    currentSettingsButtonDisplay = radio.value;
                }
            });

            // Language selection is handled immediately by the change event listener
            // (languageSelect.addEventListener('change', ...))

            saveSettings();
            applyPageTitleSettings();
            applyTabTitleSettings();
            applySearchPosition();
            applyBackgroundSettings();
            applyGridSettings();
            applySettingsButton();
            applyFavicon();
            renderButtons(); // Re-render to ensure any title changes are reflected immediately
            closeSettingsModal();
        });

        cancelSettingsButton.addEventListener('click', () => {
            closeSettingsModal();
        });

        // Function to perform search
        function performSearch() {
            const query = googleSearchInput.value.trim();
            if (query) {
                const selectedSearchProvider = quickSearchProviderSelect.value;
                const searchUrl = searchProviders[selectedSearchProvider] + encodeURIComponent(query);
                window.location.href = searchUrl;
            }
        }

        googleSearchInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                performSearch();
            }
        });

        // Event listeners for submenu navigation
        openBackgroundSettingsButton.addEventListener('click', () => showMenu('backgroundSettingsSubmenu'));
        openPageTitleSettingsButton.addEventListener('click', () => showMenu('pageTitleSettingsSubmenu'));
        openSearchBarSettingsButton.addEventListener('click', () => showMenu('searchBarSettingsSubmenu'));
        openGridSettingsButton.addEventListener('click', () => showMenu('gridSettingsSubmenu'));
        openButtonManagementButton.addEventListener('click', () => showMenu('buttonManagementSubmenu'));
        openSettingsButtonSettingsButton.addEventListener('click', () => showMenu('settingsButtonSettingsSubmenu'));
        openLanguageSettingsButton.addEventListener('click', () => showMenu('languageSettingsSubmenu')); // New listener for language settings
        openBackupRestoreSettingsButton.addEventListener('click', () => showMenu('backupRestoreSettingsSubmenu'));

        backToMainMenuButtons.forEach(button => {
            button.addEventListener('click', () => showMenu('mainSettingsMenu'));
        });

        // Language selection listener
        languageSelect.addEventListener('change', (event) => {
            setLanguage(event.target.value);
            // After changing language, update placeholders again
            googleSearchInput.placeholder = searchPlaceholders[currentActiveSearchProvider];
            // Also update any other hardcoded elements if necessary
            settingsButton.textContent = translations[currentLanguage].settings; // Re-set the settings button text
            document.getElementById('modalTitle').textContent = translations[currentLanguage].modalTitle;
            // Re-populate button select to update option text for "Select Button to Edit"
            populateButtonSelect();
        });


        exportSettingsButton.addEventListener('click', () => {
            const settingsToExport = {
                buttons: currentButtons,
                bgColor: currentBackgroundColor,
                pageTitle: currentPageTitle,
                hidePageTitle: hidePageTitle,
                tabTitle: currentTabTitle,
                defaultSearchProvider: currentDefaultSearchProvider,
                faviconBase64: currentFaviconBase64,
                backgroundType: currentBackgroundType,
                backgroundImageUrl: currentBackgroundImageUrl,
                backgroundImageBase64: currentBackgroundImageBase64,
                gradientColor1: currentGradientColor1,
                gradientColor2: currentGradientColor2,
                gradientDirection: currentGradientDirection,
                pageTitleFont: currentPageTitleFont,
                maxColumns: currentMaxColumns,
                baseTileHeight: currentBaseTileHeight,
                settingsButtonPosition: currentSettingsButtonPosition,
                settingsButtonDisplay: currentSettingsButtonDisplay,
                language: currentLanguage, // Export current language
                areButtonsLocked: areButtonsLocked // This will export the current state, but not load it back by default
            };

            const dataStr = JSON.stringify(settingsToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'browser_startpage_settings.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        importSettingsButton.addEventListener('click', () => {
            const file = importSettingsFile.files[0];
            if (!file) {
                importMessage.textContent = translations[currentLanguage].pleaseSelectJson;
                return;
            }

            cancelSettingsButton.disabled = true;
            saveSettingsButton.disabled = true;
            exportSettingsButton.disabled = true;
            importSettingsButton.disabled = true;
            importSettingsFile.disabled = true;
            resetSettingsButton.disabled = true;

            importMessage.textContent = translations[currentLanguage].importingSettings;
            importMessage.style.color = '#FFFFFF';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedSettings = JSON.parse(e.target.result);

                    if (importedSettings && typeof importedSettings === 'object' && Array.isArray(importedSettings.buttons)) {
                        localStorage.setItem('browserStartPageButtons', JSON.stringify(importedSettings.buttons));
                        localStorage.setItem('browserStartPageBgColor', importedSettings.bgColor || '#1a202c');
                        localStorage.setItem('browserStartPageTitle', importedSettings.pageTitle !== undefined ? importedSettings.pageTitle : '');
                        localStorage.setItem('browserStartPageHideTitle', importedSettings.hidePageTitle !== undefined ? importedSettings.hidePageTitle : false);
                        localStorage.setItem('browserStartPageTabTitle', importedSettings.tabTitle !== undefined ? importedSettings.tabTitle : '');
                        localStorage.setItem('browserStartPageSearchProvider', importedSettings.defaultSearchProvider || 'google');
                        localStorage.setItem('browserStartPageFavicon', importedSettings.faviconBase64 || '');
                        localStorage.setItem('browserStartPageBackgroundType', importedSettings.backgroundType || 'color');
                        localStorage.setItem('browserStartPageBackgroundImageUrl', importedSettings.backgroundImageUrl || '');
                        localStorage.setItem('browserStartPageBackgroundImageBase64', importedSettings.backgroundImageBase64 || '');
                        localStorage.setItem('browserStartPageGradientColor1', importedSettings.gradientColor1 || '#4F46E5');
                        localStorage.setItem('browserStartPageGradientColor2', importedSettings.gradientColor2 || '#EC4899');
                        localStorage.setItem('browserStartPageGradientDirection', importedSettings.gradientDirection || 'to right');
                        localStorage.setItem('browserStartPageTitleFont', importedSettings.pageTitleFont || 'Inter, sans-serif');
                        localStorage.setItem('browserStartPageMaxColumns', importedSettings.maxColumns !== undefined ? importedSettings.maxColumns : 6);
                        localStorage.setItem('browserStartPageBaseTileHeight', importedSettings.baseTileHeight !== undefined ? importedSettings.baseTileHeight : 150);
                        localStorage.setItem('browserStartPageSettingsButtonPosition', importedSettings.settingsButtonPosition || 'bottom-right');
                        localStorage.setItem('browserStartPageSettingsButtonDisplay', importedSettings.settingsButtonDisplay || 'text');
                        localStorage.setItem('browserStartPageLanguage', importedSettings.language || 'de'); // Import language

                        importMessage.textContent = translations[importedSettings.language || 'de'].settingsImported;
                        importMessage.style.color = '#48BB78';
                        setTimeout(() => {
                            location.reload();
                        }, 1500);

                    } else {
                        importMessage.textContent = translations[currentLanguage].invalidFileFormat;
                        importMessage.style.color = '#F56565';
                        cancelSettingsButton.disabled = false;
                        saveSettingsButton.disabled = false;
                        exportSettingsButton.disabled = false;
                        importSettingsButton.disabled = false;
                        importSettingsFile.disabled = false;
                        resetSettingsButton.disabled = false;
                    }
                } catch (error) {
                    console.error('Error parsing imported file:', error);
                    importMessage.textContent = translations[currentLanguage].errorReadingFile;
                    importMessage.style.color = '#F56565';
                    cancelSettingsButton.disabled = false;
                    saveSettingsButton.disabled = false;
                    exportSettingsButton.disabled = false;
                    importSettingsButton.disabled = false;
                    importSettingsFile.disabled = false;
                    resetSettingsButton.disabled = false;
                }
            };
            reader.readAsText(file);
        });

        function showConfirmationModal(message, onConfirmCallback) {
            confirmationMessage.textContent = message;
            confirmationModal.style.display = 'flex';

            settingsModal.style.pointerEvents = 'none';
            settingsModal.style.opacity = '0.5';

            confirmYesButton.onclick = null;
            confirmNoButton.onclick = null;

            confirmYesButton.onclick = () => {
                onConfirmCallback();
                hideConfirmationModal();
            };

            confirmNoButton.onclick = () => {
                hideConfirmationModal();
                cancelSettingsButton.disabled = false;
                saveSettingsButton.disabled = false;
                exportSettingsButton.disabled = false;
                importSettingsButton.disabled = false;
                importSettingsFile.disabled = false;
                resetSettingsButton.disabled = false;
            };
        }

        function hideConfirmationModal() {
            confirmationModal.style.display = 'none';
            settingsModal.style.pointerEvents = 'auto';
            settingsModal.style.opacity = '1';
        }

        resetSettingsButton.addEventListener('click', () => {
            cancelSettingsButton.disabled = true;
            saveSettingsButton.disabled = true;
            exportSettingsButton.disabled = true;
            importSettingsButton.disabled = true;
            importSettingsFile.disabled = true;
            resetSettingsButton.disabled = true;

            importMessage.textContent = '';

            showConfirmationModal(translations[currentLanguage].confirmReset, () => {
                localStorage.removeItem('browserStartPageButtons');
                localStorage.removeItem('browserStartPageBgColor');
                localStorage.removeItem('browserStartPageTitle');
                localStorage.removeItem('browserStartPageHideTitle');
                localStorage.removeItem('browserStartPageTabTitle');
                localStorage.removeItem('browserStartPageSearchProvider');
                localStorage.removeItem('browserStartPageFavicon');
                localStorage.removeItem('browserStartPageBackgroundType');
                localStorage.removeItem('browserStartPageBackgroundImageUrl');
                localStorage.removeItem('browserStartPageBackgroundImageBase64');
                localStorage.removeItem('browserStartPageGradientColor1');
                localStorage.removeItem('browserStartPageGradientColor2');
                localStorage.removeItem('browserStartPageGradientDirection');
                localStorage.removeItem('browserStartPageTitleFont');
                localStorage.removeItem('browserStartPageMaxColumns');
                localStorage.removeItem('browserStartPageBaseTileHeight');
                localStorage.removeItem('browserStartPageSettingsButtonPosition');
                localStorage.removeItem('browserStartPageSettingsButtonDisplay');
                localStorage.removeItem('browserStartPageLanguage'); // Remove stored language
                localStorage.removeItem('browserStartPageAreButtonsLocked'); // This removes the stored lock state

                importMessage.textContent = translations[currentLanguage].settingsReset;
                importMessage.style.color = '#48BB78';
                setTimeout(() => {
                    location.reload();
                }, 1500);
            });
        });


        function init() {
            // Initialize DOM elements here after DOM is loaded
            settingsButton = document.getElementById('settingsButton');
            toggleLockButtonsButton = document.getElementById('toggleLockButtonsButton');
            controlButtonsContainer = document.getElementById('controlButtonsContainer');
            searchIcon = document.getElementById('searchIcon'); // Initialize search icon

            loadSettings(); // areButtonsLocked is set to true here
            setLanguage(currentLanguage); // Apply initial language from loaded settings

            applyBackgroundSettings();
            applyPageTitleSettings();
            applyTabTitleSettings();
            applySearchPosition();
            applyGridSettings();
            applySettingsButton();
            applyToggleLockButtonState(); // Update UI status of the lock button
            applyFavicon();

            quickSearchProviderSelect.value = currentActiveSearchProvider;
            googleSearchInput.placeholder = searchPlaceholders[currentActiveSearchProvider];
            googleSearchInput.value = ''; // Set search bar value to empty on page load

            // Create the line indicator once
            lineIndicator = document.createElement('div');
            lineIndicator.classList.add('line-indicator');
            lineIndicator.style.width = '2px'; // Ensure it has a width
            lineIndicator.style.display = 'none'; // Initially hidden

            // Event listeners added here after elements are initialized
            settingsButton.addEventListener('click', openSettingsModal);
            toggleLockButtonsButton.addEventListener('click', () => {
                areButtonsLocked = !areButtonsLocked;
                applyToggleLockButtonState();
                saveSettings(); // Does NOT save the lock status
            });

            // Global Drag & Drop Listeners for the tilesContainer
            tilesContainer.addEventListener('dragover', handleDragOver);
            tilesContainer.addEventListener('drop', handleDrop);
            tilesContainer.addEventListener('dragleave', handleDragLeave);
            tilesContainer.addEventListener('dragend', handleDragEnd); // Important for cleanup

            // Event listener for the search icon
            searchIcon.addEventListener('click', performSearch);
            quickSearchProviderSelect.addEventListener('change', () => {
                const selectedProvider = quickSearchProviderSelect.value;
                googleSearchInput.placeholder = searchPlaceholders[selectedProvider];
                currentActiveSearchProvider = selectedProvider;
            });

            // Initial rendering of buttons (and line indicator will be re-appended)
            renderButtons();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
